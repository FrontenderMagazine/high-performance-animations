# Высокопроизводительная анимация

Перейдём сразу к сути. Современные браузеры способны выполнять анимацию 
следующих четырех параметров с минимальной затратой ресурсов: **позиционирование**, 
**масштаб**, **вращение** и **изменение прозрачности**. Если вы хотите выполнить 
анимацию чего-либо ещё, делайте это *на свой страх и риск*, скорее всего таких 
желанных 60 кадров за секунду при этом не видать.

![рисунок][Дешевая анимация]

Взгляните на это замедленное видео-сравнение одной и той же анимации:

<iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" src="//www.youtube.com/embed/-62uPWUxgcg?rel=0" allowfullscreen="" frameborder="0"></iframe>

На одном из видео она выполнена с помощью трансформации, на втором — нет. Вы 
сами видите какая при этом между ними разница, давайте же разберёмся в чём 
причина.

## От дерева документа к пикселям с помощью инструментов разработчика

Открыв временную шкалу в инструментах разработчика Chrome, вы должны увидеть 
схему вроде этой:

![скриншот][каскад в инструментах разработчика] 

*Кадровый режим инструментов разработчика Chrome. Чем выше в каскаде точка, с 
которой вы начинаете, тем больше работы выполняет браузер*

Ход работы браузера довольно прост: рассчитать стили, которые применяются для 
элементов (перерасчёт стилей), сгенерировать геометрию и расположение каждого 
элемента (структура), заполнить пиксели каждого элемента по [слоям][1] 
(настройка отрисовки и отрисовка) и выведение слоев на экран (комбинирование 
слоев).

Чтобы получить безупречно плавную анимацию, нужно свести работу к минимуму, 
лучший способ сделать это — изменять только те свойства, что затрагивают 
комбинирование —  `transform` и `opacity`. **Чем выше в каскаде точка, с которой 
вы начинаете, тем больший объем работы нужно проделать браузеру чтобы вывести 
пиксели на экран.**

> Этот совет является практически полностью кроссбраузерным. Chrome, Firefox, 
Safari и Opera выполняют аппаратное ускорение трансформаций и смены прозрачности. 
К сожалению, пока не ясно по каким критериям Internet Explorer 10+ определяет 
уместность аппаратного ускорения, однако будем надеяться что всё прояснится 
когда в IE11 будут введены средства разработчика F12.

## Анимация свойств структуры

При изменении элементов у браузера может возникнуть необходимость поработать над 
структурой, что включает в себя расчёт геометрии (размещения и размеров) 
элементов, на которых повлияли изменения. Если вы изменили один элемент, может 
потребоваться перерасчёт геометрии других элементов. Например, если изменить 
ширину элемента `<html>`, это может повлиять на любой из его дочерних элементов. 
Вследствие того как элементы перекрывают и влияют друг на друга, изменения вниз 
по дереву документа иногда могут привести к необходимости перерасчёта структуры 
вплоть до самой вершины.

Чем больше дерево видимых элементов, тем больше времени занимает выполнение 
расчётов структуры, так что лучше приложить все усилия для избежания анимации 
свойств, запускающих её перерасчёт.

> Вы храните состояние приложения в элементах `or` с классами? Когда эти 
элементы изменяются, браузеру может понадобиться провести перерасчёт стилей и 
структуры. Остерегайтесь случайных активаторов перерасчёта структуры в своих 
приложениях; они могут оказаться очень дорогими даже если анимация для них не 
выполняется!

Вот некоторые [наиболее популярные CSS-свойства][2], которые будучи изменены 
запускают перерасчёт структуры:

**Стили, которые влияют на структуру**

<table>
<tr><td>width</td><td>height</td></tr>
<tr><td>padding</td><td>margin</td></tr>
<tr><td>display</td><td>border-width</td></tr>
<tr><td>border</td><td>top</td></tr>
<tr><td>position</td><td>font-size</td></tr>
<tr><td>float</td><td>text-align</td></tr>
<tr><td>overflow-y</td><td>font-weight</td></tr>
<tr><td>overflow</td><td>left</td></tr>
<tr><td>font-family</td><td>line-height</td></tr>
<tr><td>vertical-align</td><td>right</td></tr>
<tr><td>clear</td><td>white-space</td></tr>
<tr><td>bottom</td><td>min-height</td></tr>
</table>

Источник: [http://goo.gl/lPVJY6][3]

## Анимация свойств отрисовки

Изменение элемента также может активировать отрисовку, в большинстве случаев в 
современных браузерах она проводится программными средствами прорисовки. В 
зависимости от того, как элементы в вашем приложении сгруппированы по слоям, 
другие элементы кроме изменённого могут также нуждаться в отрисовке.

> Если вам не знакома концепция слоев, почитайте [введение в эту тему][4] от 
Тома Вильциуса (Tom Wiltzius).

Есть большое количество свойств, которые активируют отрисовку, вот самые 
популярные из них:

**Стили, которые влияют на отрисовку**

<table>
<tr><td>color</td><td>border-style</td></tr>
<tr><td>visibility</td><td>background</td></tr>
<tr><td>text-decoration</td><td>background-image</td></tr>
<tr><td>background-position</td><td>background-repeat</td></tr>
<tr><td>outline-color</td><td>outline</td></tr>
<tr><td>outline-style</td><td>border-radius</td></tr>
<tr><td>outline-width</td><td>box-shadow</td></tr>
<tr><td>background-size</td><td></td></tr>
</table>

Источник: [http://goo.gl/lPVJY6][5]

Если вы добавите анимацию для любого из вышеперечисленных свойств, элементы, 
которые она затронет, будут перерисованы и слои, к которым они относятся, будут 
загружены в графический процессор. Это обойдется особенно дорого на мобильных 
устройствах, где центральные процессоры намного менее мощные чем их аналоги на 
настольных компьютерах, следовательно, на работу по отрисовке требуется больше 
времени; кроме того, пропускная полоса между центральным и графическим 
процессором ограничена, так что загрузка текстур занимает много времени.

## Анимация свойств композиции

Существует одно CSS-свойство, которое иногда может не запускать отрисовку, хотя 
вы этого и ожидаете: прозрачность `opacity`. Изменения прозрачности могут 
обрабатываться графическим процессором в процессе компоновки путём отрисовки 
текстуры элемента с более низким значением альфа-фактора. Однако, чтобы это 
сработало, элемент должен быть **единственным на своем слое**. Если он размещён 
там в группе с другими элементами, изменение прозрачности графическим 
процессором приведёт к изменению (ненужному) и их прозрачности.

В браузерах Blink и WebKit создание нового слоя происходит для любого элемента, 
для которого применяется переход или анимация прозрачности с помощью CSS, однако 
многие разработчики используют `translateZ(0)` или `translate3d(0,0,0)` чтобы 
создать слой принудительно. Принудительное создание слоев гарантирует, что слой 
будет отрисован и готов к работе как только начнётся произведение анимации 
(создание и отрисовка слоя является нетривиальной операцией, которая может 
привести к задержке начала анимации) и что не возникнут никакие непредвиденные 
изменения его внешнего вида вследствие изменений сглаживания. С внедрением слоев, 
однако, нужно быть осторожным; если перестараться и создать [слишком много слоев, 
получите кучу мусора][6].

> В Chrome для некоренных слоев с прозрачностью используется [не субпиксельное, 
а полутоновое сглаживание][7], что может быть очень заметным, особенно при 
неожиданном изменении метода сглаживания. Если вы собираетесь перенести элемент 
на новый слой, не ждите начала анимации, сделайте это заранее.

Трансформация элемента сводится к изменениям его размещения, вращению или 
масштабированию. Анимация смены размещения часто выполняется путём указания 
свойств `left` и `top`. Проблема здесь в том, что, как показано выше, и `left` и 
`top` активируют операции по перерасчёту структуры, которые являются дорогими. 
Более удачное решение — использовать для элемента функцию `translate`, которая 
не запускает перерасчёт структуры.

> В Chrome Canary и Safari можно также выполнять анимацию фильтров, так как они 
выполняются вне основного потока, проходят ускорение и в общем работают очень 
хорошо. Однако, так как фильтры пока не поддерживаются в Internet Explorer и 
Firefox, их следует использовать с осторожностью.

## Императивная и декларативная анимация

Разработчикам часто приходится решать как именно добавлять анимацию: через 
JavaScript (императивно) или CSS (декларативно). У обеих способов есть за и 
против, давайте рассмотрим их подробнее:

### Императивная анимация

Главный плюс императивной анимации является в то же время и его главным минусом: 
она выполняется в основном потоке браузера с помощью JavaScript. Основной поток 
итак уже занят выполнением других скриптов JavaScript, вычислениями стилей, 
структуры и отрисовки. Часто в потоке возникают конфликтные ситуации. Это 
существенно повышает вероятность потери фреймов анимации, чего вы хотели бы в 
последнюю очередь.

Использование JavaScript для анимации даёт вам большую возможность контроля: 
операции запуска, приостановки, изменения направления, прерывания и отмены 
являются очень простыми. Некоторых эффектов вроде [параллакс][8]-прокрутки можно 
добиться только с помощью JavaScript.

### Декларативная анимация

Альтернативный подход предусматривает написание переходов и анимации в CSS. 
Главным его преимуществом является то, что у браузера есть возможность 
оптимизировать такую анимацию. При необходимости он может создать слои и 
выполнить некоторые операции вне основного потока, что как вы уже убедились, 
хорошо. Главным недостатком CSS-анимаций является нехватка выразительных 
возможностей анимации JavaScript. Комбинировать анимации в эффективный способ 
непросто, а это значит, что их создание становится сложным и подверженным 
погрешностям.

## Смотрим в будущее

По мере развития веб-стандартов некоторые ограничения в анимации уйдут в прошлое. 
Поступило предложение от Яна Воллика (Ian Vollick) из Google, который занимается 
исследованием концепции разрешения [выполнения JavaScript-анимации с помощью 
работников(workers)][9], представляя анимацию, которая бы не активировала перерасчёт 
структуры или стилей.

Для тех, кто интересуется более декларативным подходом к анимации, была создана 
[спецификация по веб-анимации][10], о которой [много писал Джейк Арчибальд (Jake 
Archibald)][11].

## Заключение

Качественная анимация является ключом к безупречному опыту использования сети. 
Нужно всегда быть начеку, чтобы избежать анимации свойств, запускающих 
перерасчёт структуры или отрисовки, которые являются дорогими операциями и могут 
повлечь за собой пропуск кадров. Декларативная анимация является более 
предпочтительной, чем императивная, так как у браузера есть возможность 
оптимизировать её заранее.

На сегодня наиболее подходящими свойствами для анимации являются свойства 
трансформации, так как графический процессор может помочь с сопутствующими 
сложными задачами. Так что, когда это возможно, ограничьтесь анимацией 
следующего:

* прозрачности `opacity`
* перемещения `translate`
* вращения `rotate`
* масштабирования `scale`

В будущем, возможно, появятся новые методы анимации, которые позволят вам 
создавать столь же выразительные эффекты, что и через JavaScript, но при этом не 
загружать основной поток. Или же столь же щадящие к вычислительным ресурсам, как 
CSS, но лишенные ограничений данного метода. Но до того времени лучше 
планировать анимацию с мыслью о последующей корректной и гладкой работе.

## Использованные источники

* [Текущий статус анимированных свойств в веб][12].
* [Презентация Пола Айриша (Paul Irish) инструментов для производительности][13].
* [Введение в сглаживание][14]
* [Нам понадобится API побольше!][15]

[1]: http://www.html5rocks.com/en/tutorials/speed/layers/
[2]: https://docs.google.com/spreadsheet/pub?key=0ArK1Uipy0SbDdHVLc1ozTFlja1dhb25QNGhJMXN5MXc&single=true&gid=0&output=html
[3]: https://docs.google.com/spreadsheet/pub?key=0ArK1Uipy0SbDdHVLc1ozTFlja1dhb25QNGhJMXN5MXc&single=true&gid=0&output=html
[4]: http://www.html5rocks.com/en/tutorials/speed/layers/
[5]: https://docs.google.com/spreadsheet/pub?key=0ArK1Uipy0SbDdHVLc1ozTFlja1dhb25QNGhJMXN5MXc&single=true&gid=0&output=html
[6]: http://wesleyhales.com/blog/2013/10/26/Jank-Busting-Apples-Home-Page/
[7]: http://www.html5rocks.com/en/tutorials/internals/antialiasing-101/
[8]: http://www.html5rocks.com/en/tutorials/speed/parallax/
[9]: https://github.com/ianvollick/animation-proxy/blob/master/Explainer.md
[10]: http://dev.w3.org/fxtf/web-animations/
[11]: http://www.smashingmagazine.com/2013/03/04/animating-web-gonna-need-bigger-api/
[12]: http://www.chromestatus.com/metrics/css/animated
[13]: https://docs.google.com/presentation/d/19R_E5B__kdE55L1bTpS6IFKbYbHq-PQKKky4do5Yc6A/edit#slide=id.g105c64d69_170
[14]: http://www.html5rocks.com/en/tutorials/internals/antialiasing-101/
[15]: http://www.smashingmagazine.com/2013/03/04/animating-web-gonna-need-bigger-api/

[Дешевая анимация]: img/cheap-operations-ru.jpg
[каскад в инструментах разработчика]: img/devtools-waterfall-ru.jpg
